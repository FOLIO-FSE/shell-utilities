#!/usr/bin/bash
auth 2>/dev/null || authn 2>/dev/null
okapi_url=$(cat okapi.url)
tenant=$(cat tenant)
okapi_token=$(cat okapi.token)

if [[ -z ${2} ]];then
	echo "Usage: circrules-test [user_barcode] [item_barcode]"
	exit
fi

userId=$(curl -s -w '\n' -X GET -D -H "Accept: application/json" -H "X-Okapi-Tenant: ${tenant}" -H "x-okapi-token: ${okapi_token}" "${okapi_url}/users?query=barcode==${1}" |jq -r .users[0].id)
itemId=$(curl -s -w '\n' -X GET -D -H "Accept: application/json" -H "X-Okapi-Tenant: ${tenant}" -H "x-okapi-token: ${okapi_token}" "${okapi_url}/inventory/items?query=barcode==${2}" |jq -r .items[0].id) 


loan=$(curl -s -w '\n' -X GET -D -H "Accept: application/json" -H "X-Okapi-Tenant: ${tenant}" -H "x-okapi-token: ${okapi_token}" "${okapi_url}/loan-storage/loans?query=itemId==${itemId}%20and%20userId==${userId}%20sortby%20loanDate%20desc" |jq '.loans[0]')

loanPolicyId=$(jq -r .loanPolicyId <<< "${loan}")
patronGroupIdAtCheckout=$(jq -r .patronGroupIdAtCheckout <<< "${loan}")
overdueFinePolicyId=$(jq -r .overdueFinePolicyId <<< "${loan}")
lostItemPolicyId=$(jq -r .lostItemPolicyId <<< "${loan}")

circrules-get > circrules.json

jq --arg loanPolicyId "${loanPolicyId}" \
   --arg patronGroupIdAtCheckout "${patronGroupIdAtCheckout}" \
   --arg overdueFinePolicyId "${overdueFinePolicyId}" \
   --arg lostItemPolicyId "${lostItemPolicyId}" '
  .rulesAsText
  | gsub("\r";"")                                   # normalize CRLF if present
  | split("\n")                                     # split into lines
  | to_entries                                      # [{key, value}, ...] where key is 0-based
  | map(select(
      (.value | test("\\b\($loanPolicyId)\\b")) and
      (.value | test("\\b\($patronGroupIdAtCheckout)\\b")) and
      (.value | test("\\b\($overdueFinePolicyId)\\b")) and
      (.value | test("\\b\($lostItemPolicyId)\\b"))
    ))
  | map(
      (.value | capture("(?<rule>.*?)\\s*:\\s*(?<action>.*)")) as $parts
      | { line: (.key + 1), rule: $parts.rule, action: $parts.action }
    )
' circrules.json


#!/usr/bin/bash
auth 2>/dev/null || authn 2>/dev/null
okapi_url=$(cat okapi.url)
tenant=$(cat tenant)
okapi_token=$(cat okapi.token)
testKey="."

if [[ -z ${2} ]];then
	echo "Usage: circrule-get [user_barcode] [item_barcode] "
	echo
	exit
fi

echo "Retrieving user, item, and reference data. Please wait"

user=$(curl -s -w '\n' -X GET -D -H "Accept: application/json" -H "X-Okapi-Tenant: ${tenant}" -H "x-okapi-token: ${okapi_token}" "${okapi_url}/users?query=barcode==${1}" |jq -c .users[0]) 
item=$(curl -s -w '\n' -X GET -D -H "Accept: application/json" -H "X-Okapi-Tenant: ${tenant}" -H "x-okapi-token: ${okapi_token}" "${okapi_url}/inventory/items?query=barcode==${2}" |jq -c .items[0]) 

itemId=$(jq -r .id <<< "${item}")
userId=$(jq -r .id <<< "${user}")

loan=$(curl -s -w '\n' -X GET -D -H "Accept: application/json" -H "X-Okapi-Tenant: ${tenant}" -H "x-okapi-token: ${okapi_token}" "${okapi_url}/loan-storage/loans?query=itemId==${itemId}%20and%20userId==${userId}%20sortby%20loanDate%20desc" |jq '.loans[0]')

materialTypeId=$(jq -r .materialType.id <<< "${item}")
loanTypeId=$(jq -r .permanentLoanType.id <<< "${item}")

loanPolicyId=$(jq -r .loanPolicyId <<< "${loan}")
patronGroupIdAtCheckout=$(jq -r .patronGroupIdAtCheckout <<< "${loan}")
overdueFinePolicyId=$(jq -r .overdueFinePolicyId <<< "${loan}")
lostItemPolicyId=$(jq -r .lostItemPolicyId <<< "${loan}")
locationId=$(jq -r .itemEffectiveLocationIdAtCheckOut <<< "${loan}")

circRulesFromAPI=$(curl -s -w '\n' -X GET -H "Accept: application/json" -H "X-Okapi-Tenant: ${tenant}" -H "x-okapi-token: ${okapi_token}" "${okapi_url}/circulation/rules/loan-policy-all?item_type_id=${materialTypeId}&loan_type_id=${loanTypeId}&patron_type_id=${patronGroupIdAtCheckout}&location_id=${locationId}"|jq .circulationRuleMatches)

echo "Evaluating circulation rules"

curl -s -w '\n' -X GET -H "Accept: application/json" -H "X-Okapi-Tenant: ${tenant}" -H "x-okapi-token: ${okapi_token}" "${okapi_url}/circulation/rules" > circrules.json  &
curl -s -w '\n' -X GET -H "Accept: application/json" -H "X-Okapi-Tenant: ${tenant}" -H "x-okapi-token: ${okapi_token}" "${okapi_url}/loan-types?query=cql.allRecords=1&limit=1000" |jq -c .loantypes[] > loantypes.json &
curl -s -w '\n' -X GET -H "Accept: application/json" -H "X-Okapi-Tenant: ${tenant}" -H "x-okapi-token: ${okapi_token}" "${okapi_url}/material-types?query=cql.allRecords=1&limit=1000" |jq -c .mtypes[] > mattypes.json &
curl -s -w '\n' -X GET -H "Accept: application/json" -H "X-Okapi-Tenant: ${tenant}" -H "x-okapi-token: ${okapi_token}" "${okapi_url}/groups?query=cql.allRecords=1&limit=1000" |jq -c .usergroups[] > groups.json &
curl -s -w '\n' -X GET -H "Accept: application/json" -H "X-Okapi-Tenant: ${tenant}" -H "x-okapi-token: ${okapi_token}" "${okapi_url}/loan-policy-storage/loan-policies?query=cql.allRecords=1&limit=1000" |jq -c .loanPolicies[] > loanpolicies.json &
curl -s -w '\n' -X GET -H "Accept: application/json" -H "X-Okapi-Tenant: ${tenant}" -H "x-okapi-token: ${okapi_token}" "${okapi_url}/lost-item-fees-policies?query=cql.allRecords=1&limit=1000" |jq -c .lostItemFeePolicies[] > lostitempolicies.json &
curl -s -w '\n' -X GET -H "Accept: application/json" -H "X-Okapi-Tenant: ${tenant}" -H "x-okapi-token: ${okapi_token}" "${okapi_url}/overdue-fines-policies?query=cql.allRecords=1&limit=1000" |jq -c .overdueFinePolicies[] > overduefinepolicies.json &
curl -s -w '\n' -X GET -H "Accept: application/json" -H "X-Okapi-Tenant: ${tenant}" -H "x-okapi-token: ${okapi_token}" "${okapi_url}/patron-notice-policy-storage/patron-notice-policies?query=cql.allRecords=1&limit=1000" |jq -c .patronNoticePolicies[] > noticepolicies.json &
curl -s -w '\n' -X GET -H "Accept: application/json" -H "X-Okapi-Tenant: ${tenant}" -H "x-okapi-token: ${okapi_token}" "${okapi_url}/request-policy-storage/request-policies?query=cql.allRecords=1&limit=1000" |jq -c .requestPolicies[] > requestpolicies.json &
wait

jq -r '. | "s/\(.id)/\((.group // .name)|gsub("/";"\\/"))/g"' loantypes.json mattypes.json groups.json loanpolicies.json lostitempolicies.json overduefinepolicies.json noticepolicies.json requestpolicies.json > temp.sed

circRulesFromLoan=$(jq --arg loanPolicyId "${loanPolicyId}" \
   --arg patronGroupIdAtCheckout "${patronGroupIdAtCheckout}" \
   --arg locationId "${locationId}" \
   --arg overdueFinePolicyId "${overdueFinePolicyId}" \
   --arg lostItemPolicyId "${lostItemPolicyId}" \
  '.rulesAsText
  | gsub("\r";"")             
  | split("\n")              
  | to_entries                                      # [{key, value}, ...] where key is 0-based
  | map(select(
      (.value | test("\($loanPolicyId)")) and
      (.value | test("\($overdueFinePolicyId)")) and
      (.value | test("\($lostItemPolicyId)"))
    ))
  | map(
      (.value | capture("(?<rule>.*?)\\s*:\\s*(?<action>.*)")) as $parts
      | { line: (.key + 1), rule: $parts.rule, action: $parts.action }
    )
' circrules.json |sed -f temp.sed)

jq -n --arg circFromLoan "${circRulesFromLoan}" --arg circFromAPI "${circRulesFromAPI}" '
  ($circFromLoan | fromjson) as $LoanJSON
  | ($circFromAPI | fromjson) as $ApiJSON
  | INDEX($ApiJSON[]; .circulationRuleLine) as $idx
  | [$LoanJSON[] | select($idx[(.line|tostring)]) | {line, rule, action}]
'

rm -f temp.sed loantypes.json mattypes.json groups.json loanpolicies.json lostitempolicies.json overduefinepolicies.json noticepolicies.json requestpolicies.json



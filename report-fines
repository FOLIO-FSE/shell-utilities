okapi_url=$(cat okapi.url)
okapi_token=$(cat okapi.token)
tenant=$(cat tenant)

echo "Retrieving all fine records"

records-get accounts

finethreshold=10

#### generate list of users and fine over threshold

cat accounts.json \
	|jq -r 'select(.status.name=="Open" and .remaining>0 )|[.userId, .remaining]|@tsv' \
	|awk -v THRESHOLD=$finethreshold 'BEGIN{FS="\t"}{ remaining[$1]+=$2 } 
		END { for (user in remaining) {
			if (remaining[user] > THRESHOLD) {
				print(user, remaining[user]) 
			}
		}}' \
	| sort -k2nr > users_fines.tmp


#### convert user uuids to barcodes and list the fine
rm -f users_fines.tsv

echo

while read -r uuid fine;do
	barcode=$(curl -s -w '\n' -X GET -D -H "Accept: application/json" -H "X-Okapi-Tenant: ${tenant}" -H "x-okapi-token: ${okapi_token}" "${okapi_url}/users/${uuid}" |jq -r .barcode)
	echo "$barcode	$fine" |tee -a users_fines.tsv
done < users_fines.tmp

rm users_fines.tmp

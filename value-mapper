#!/usr/bin/bash

read -d '' -r instructions << END
value-mapper looks for 2 column tab-delimited mapping files with the 
same names as column headers in the input file.
 
It replaces values that match the first column of the mapping file 
with the corresponding value in the second column. If no file is
found or no value in the mapping file matches the value in the input 
column, the original value is output. 

	Example:
	 
	Input file:
	col1	col2	col3
	a	b	c
	d	e	f
	g	h	i
	 
	Mapping file (named col2.tsv):
	b	x
	e	z
	 
	Output file generated:
	col1	col2	col3
	a	x	c
	d	z	f
	g	h	i


Enter the name of the tab delimited input file
END

if [[ -n "${1}" ]]; then
	infile="${1}"
	outfile="${1/.tsv/}"_fixed.tsv
else
	echo "${instructions}"
	read infile
	echo -e "\nEnter the name of the output file"
	read outfile
fi

IFS=$'\t' read -r -a headers < "${infile}"

declare -A maps
declare -A files

for header in "${headers[@]}"; do
	if [[ -f "${header}.tsv" ]]; then
		echo "Mapping file found for ${header}"

		while IFS=$'\t' read -r key value; do
			maps["${header}:${key}"]="${value}"
		done < "${header}.tsv"
		files["${header}"]=1
	fi
done

{
	printf "%s\n" "$(IFS=$'\t'; echo "${headers[*]}")"

	count=0

	pv "${infile}" | tail -n +2 | while IFS=$'\t' read -r -a row; do
		for i in "${!headers[@]}"; do
			col="${headers[${i}]}"
			val="${row[${i}]}"
			if [[ ${files[${col}]} ]]; then
			    mapped="${maps[${col}:${val}]}"
			    printf "%s" "${mapped:-${val}}"
			else
			    printf "%s" "${val}"
			fi
			[[ ${i} -lt $((${#headers[@]} - 1)) ]] && printf "\t"
		done
		printf "\n"
	done
} > "${outfile}"

echo -e "A mapped file has been sent to ${outfile}\n"
